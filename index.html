<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SEO Fortress/Stronghold Participants Extractor</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #0f172a; color: #f1f5f9; min-height: 100vh; padding: 24px 16px; }
    .wrap { max-width: 680px; margin: 0 auto; }
    h1 { font-size: 1.4rem; font-weight: 700; margin-bottom: 4px; }
    .sub { color: #94a3b8; font-size: 13px; margin-bottom: 20px; }
    .card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 16px; margin-bottom: 14px; }
    label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 6px; font-weight: 600; letter-spacing: .04em; text-transform: uppercase; }
    input[type=password] { width: 100%; padding: 10px 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: #f1f5f9; font-size: 14px; outline: none; }
    input[type=password]:focus { border-color: #6366f1; }
    .hint { font-size: 12px; color: #64748b; margin-top: 6px; }
    .hint a { color: #818cf8; }
    .steps { font-size: 12px; color: #64748b; margin-top: 8px; line-height: 1.8; }
    .steps b { color: #94a3b8; }
    .guide-grid { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 4px; }
    .guide-item { flex: 1; min-width: 160px; background: #0f172a; border: 1px solid #334155; border-radius: 10px; padding: 12px; text-align: center; }
    .guide-icon { font-size: 2rem; margin-bottom: 6px; }
    .guide-title { font-weight: 700; color: #f59e0b; margin-bottom: 4px; font-size: 14px; }
    .guide-desc { font-size: 12px; color: #94a3b8; }
    .upload-area { border: 2px dashed #334155; border-radius: 10px; padding: 32px; text-align: center; cursor: pointer; transition: border-color .2s; }
    .upload-area:hover, .upload-area.drag { border-color: #6366f1; }
    .previews { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .previews img { height: 72px; border-radius: 6px; border: 1px solid #334155; object-fit: cover; }
    .btn-row { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    button { padding: 10px 18px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all .15s; }
    button:disabled { opacity: .45; cursor: not-allowed; }
    .btn-primary { background: #6366f1; color: #fff; }
    .btn-primary:hover:not(:disabled) { background: #4f46e5; }
    .btn-copy { background: #334155; color: #f1f5f9; }
    .btn-copy.ok { background: #16a34a; color: #fff; }
    .btn-clear { background: #334155; color: #f1f5f9; }
    .log { font-size: 12px; color: #64748b; margin-top: 10px; white-space: pre-wrap; line-height: 1.6; }
    .progress { height: 4px; background: #334155; border-radius: 4px; margin-top: 12px; overflow: hidden; display: none; }
    .progress-bar { height: 100%; background: #6366f1; transition: width .3s; width: 0%; }
    .result-box { background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 14px; min-height: 80px; margin-top: 12px; }
    .target-header { font-size: 15px; font-weight: 700; color: #f59e0b; letter-spacing: .03em; margin-bottom: 4px; padding-bottom: 8px; border-bottom: 1px solid #334155; }
    .participant-count { font-size: 12px; color: #64748b; margin: 6px 0 10px; }
    .name-list { list-style: none; padding: 0; margin: 0; }
    .name-list li { padding: 5px 0; color: #e2e8f0; font-size: 14px; border-bottom: 1px solid #1e293b; display: flex; align-items: center; gap: 8px; }
    .name-num { color: #6366f1; font-size: 12px; min-width: 24px; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>‚öîÔ∏è SEO Fortress/Stronghold Participants Extractor</h1>
  <p class="sub">Upload Battle Details or Battle Record screenshots ‚Üí get participant list instantly.</p>

  <!-- What to upload guide -->
  <div class="card">
    <label>What to Upload</label>
    <div class="guide-grid">
      <div class="guide-item">
        <div class="guide-icon">üìã</div>
        <div class="guide-title">Battle Details</div>
        <div class="guide-desc">List of [SEO] players with troop counts. Scroll and screenshot all pages.</div>
      </div>
      <div class="guide-item">
        <div class="guide-icon">üìú</div>
        <div class="guide-title">Battle Record</div>
        <div class="guide-desc">Event log showing who dispatched reinforcements and launched attacks.</div>
      </div>
    </div>
  </div>

  <!-- Token input (hidden when token injected by CI) -->
  <div class="card" id="keyCard">
    <label>GitHub Token <span style="background:#1e3a5f;color:#60a5fa;font-size:11px;padding:2px 8px;border-radius:20px;margin-left:8px;">Free</span></label>
    <input type="password" id="apiKey" placeholder="ghp_‚Ä¶" autocomplete="off" />
    <div class="steps">
      <b>Get your free token:</b><br>
      1. Go to <a href="https://github.com/settings/tokens" target="_blank">github.com/settings/tokens</a><br>
      2. Generate new token (classic) ‚Üí no scopes needed ‚Üí Generate<br>
      3. Also visit <a href="https://github.com/marketplace/models" target="_blank">github.com/marketplace/models</a> to activate access
    </div>
  </div>

  <!-- Upload -->
  <div class="card">
    <label>Screenshots</label>
    <div class="upload-area" id="dropZone">
      <input type="file" id="fileInput" accept="image/*" multiple style="display:none" />
      <div style="font-size:2rem;margin-bottom:8px;">üñºÔ∏è</div>
      <div style="color:#94a3b8;font-size:14px;">Click to upload or drag & drop<br><small>Battle Details + Battle Record screens</small></div>
    </div>
    <div class="previews" id="previews"></div>

    <div class="btn-row">
      <button class="btn-primary" id="runBtn" disabled>Extract Names</button>
      <button class="btn-copy" id="copyBtn" disabled>Copy</button>
      <button class="btn-clear" id="clearBtn">Clear</button>
    </div>

    <div class="progress" id="progressWrap">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="log" id="logEl"></div>
  </div>

  <!-- Result -->
  <div class="card" id="outputCard" style="display:none">
    <label>Result</label>
    <div class="result-box" id="outputEl"></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ Token (injected by GitHub Actions at build time) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BUILT_IN_TOKEN = "__HF_TOKEN__";
const hasBuiltInToken = BUILT_IN_TOKEN && !BUILT_IN_TOKEN.startsWith("__");

const keyCard    = document.getElementById("keyCard");
const apiKeyEl   = document.getElementById("apiKey");
const fileInput  = document.getElementById("fileInput");
const dropZone   = document.getElementById("dropZone");
const previewsEl = document.getElementById("previews");
const runBtn     = document.getElementById("runBtn");
const copyBtn    = document.getElementById("copyBtn");
const clearBtn   = document.getElementById("clearBtn");
const logEl      = document.getElementById("logEl");
const outputEl   = document.getElementById("outputEl");
const outputCard = document.getElementById("outputCard");
const progressWrap = document.getElementById("progressWrap");
const progressBar  = document.getElementById("progressBar");

if (hasBuiltInToken) {
  keyCard.style.display = "none";
} else {
  const saved = localStorage.getItem("gh_token");
  if (saved) apiKeyEl.value = saved;
  apiKeyEl.addEventListener("input", () => {
    localStorage.setItem("gh_token", apiKeyEl.value.trim());
    updateRunBtn();
  });
}

function getToken() {
  return hasBuiltInToken ? BUILT_IN_TOKEN : apiKeyEl.value.trim();
}

function updateRunBtn() {
  runBtn.disabled = !selectedFiles.length || (!hasBuiltInToken && !apiKeyEl.value.trim());
}

// ‚îÄ‚îÄ‚îÄ File handling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let selectedFiles = [];

dropZone.addEventListener("click", () => fileInput.click());
fileInput.addEventListener("change", e => addFiles([...e.target.files]));
dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("drag"); });
dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag"));
dropZone.addEventListener("drop", e => {
  e.preventDefault();
  dropZone.classList.remove("drag");
  addFiles([...e.dataTransfer.files]);
});

function addFiles(files) {
  files.filter(f => f.type.startsWith("image/")).forEach(f => selectedFiles.push(f));
  renderPreviews();
  updateRunBtn();
}

function renderPreviews() {
  previewsEl.innerHTML = "";
  selectedFiles.forEach(f => {
    const img = document.createElement("img");
    img.src = URL.createObjectURL(f);
    previewsEl.appendChild(img);
  });
}

// ‚îÄ‚îÄ‚îÄ Image resize ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function resizeImage(file, maxW = 1024) {
  return new Promise((res, rej) => {
    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        const scale = Math.min(1, maxW / img.width);
        const w = Math.round(img.width * scale);
        const h = Math.round(img.height * scale);
        const c = document.createElement("canvas");
        c.width = w; c.height = h;
        c.getContext("2d").drawImage(img, 0, 0, w, h);
        res(c.toDataURL("image/jpeg", 0.92));
      };
      img.onerror = rej;
      img.src = reader.result;
    };
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
}

// ‚îÄ‚îÄ‚îÄ API call ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PROMPT = `You are extracting participant names from a mobile strategy game screenshot.

Carefully read ALL text in the image. Extract:
1. Every player name that appears with a [SEO] clan tag ‚Äî list WITHOUT the [SEO] prefix
2. Any Stronghold or Fortress number (e.g. "Stronghold No. 2" ‚Üí type: Stronghold, num: 2)

Rules:
- Include names from Battle Details lists AND Battle Record event logs
- In Battle Record: include [SEO] members who dispatched reinforcements, launched attacks, or are defenders
- Exclude non-SEO players (e.g. [DTH] or other clan tags)
- Names may be English or Cyrillic ‚Äî include both
- Names with spaces are valid (e.g. "Que Pereza", "Flustered Panda", "–ö–æ—Ä–æ–ª—å –°–µ–≤–µ—Ä–∞")
- Return ONLY raw JSON, no markdown, no explanation

Format:
{"names":["Name1","Name2"],"targets":[{"type":"Stronghold","num":2}]}

If no target found, return targets as [].`;

async function queryGitHub(token, dataUrl) {
  const resp = await fetch("https://models.inference.ai.azure.com/chat/completions", {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      model: "gpt-4o-mini",
      max_tokens: 512,
      messages: [{
        role: "user",
        content: [
          { type: "image_url", image_url: { url: dataUrl } },
          { type: "text", text: PROMPT }
        ]
      }]
    })
  });

  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    throw new Error(err?.error?.message || `HTTP ${resp.status}`);
  }

  const data = await resp.json();
  return data?.choices?.[0]?.message?.content || "";
}

// ‚îÄ‚îÄ‚îÄ Render result ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderResult(targets, names) {
  const header = targets.length
    ? targets.map(t => `‚öîÔ∏è ${t.type} ${t.num} Participants`).join(" &amp; ")
    : "‚öîÔ∏è Target ? Participants";

  const rows = names.map((n, i) =>
    `<li><span class="name-num">${i + 1}.</span>${n}</li>`
  ).join("");

  outputEl.innerHTML = `
    <div class="target-header">${header}</div>
    <div class="participant-count">${names.length} participant(s)</div>
    <ul class="name-list">${rows}</ul>
  `;

  outputCard.style.display = "block";
  outputCard.scrollIntoView({ behavior: "smooth", block: "start" });
  copyBtn.disabled = false;
}

// ‚îÄ‚îÄ‚îÄ Extract ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
runBtn.addEventListener("click", async () => {
  const token = getToken();
  if (!token || !selectedFiles.length) return;

  runBtn.disabled = true;
  copyBtn.disabled = true;
  outputCard.style.display = "none";
  outputEl.innerHTML = "";
  logEl.textContent = "";
  progressWrap.style.display = "block";
  progressBar.style.width = "0%";

  const logs = [];
  const allNames = new Set();
  const allTargets = new Map();

  const log = (msg, replace = false) => {
    if (replace) logs[logs.length - 1] = msg;
    else logs.push(msg);
    logEl.textContent = logs.join("\n");
  };

  for (let i = 0; i < selectedFiles.length; i++) {
    const f = selectedFiles[i];
    log(`üì∑ Image ${i + 1}/${selectedFiles.length}: ${f.name}`);
    progressBar.style.width = `${Math.round((i / selectedFiles.length) * 100)}%`;

    // Countdown delay between images
    if (i > 0) {
      for (let s = 30; s > 0; s--) {
        log(`   ‚è≥ Waiting ${s}s before next image‚Ä¶`, true);
        await new Promise(r => setTimeout(r, 1000));
      }
      log(`   ‚è≥ Sending‚Ä¶`, true);
    }

    try {
      const dataUrl = await resizeImage(f);
      const raw = await queryGitHub(token, dataUrl);

      const jsonMatch = raw.replace(/```json|```/g, "").trim().match(/\{[\s\S]*\}/);
      if (!jsonMatch) throw new Error("No JSON in response");

      const parsed = JSON.parse(jsonMatch[0]);
      const names = (parsed.names || []).filter(n => n && n.trim().length >= 2);
      names.forEach(n => allNames.add(n.trim()));
      (parsed.targets || []).forEach(t => {
        if (t.type && t.num) allTargets.set(`${t.type}|${t.num}`, t);
      });

      log(`   ‚úÖ Found ${names.length} name(s): ${names.join(", ")}`, i > 0);
    } catch (e) {
      log(`   ‚ùå Error: ${e.message}`, i > 0);
    }
  }

  progressBar.style.width = "100%";

  const uniqueNames = [...allNames];
  const targets = [...allTargets.values()].sort((a, b) =>
    a.type.localeCompare(b.type) || a.num - b.num
  );

  log(`\n‚úÖ Done ‚Äî ${uniqueNames.length} unique SEO participant(s) found.`);

  if (uniqueNames.length > 0) {
    renderResult(targets, uniqueNames);
  }

  runBtn.disabled = false;
  updateRunBtn();
});

// ‚îÄ‚îÄ‚îÄ Copy ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
copyBtn.addEventListener("click", () => {
  const header = outputEl.querySelector(".target-header")?.textContent || "";
  const names = [...outputEl.querySelectorAll(".name-list li")]
    .map(li => li.querySelector(".name-num") 
      ? li.textContent.replace(/^\d+\./, "").trim()
      : li.textContent.trim());
  const text = [header, ...names].join("\n").trim();
  if (!text) return;
  navigator.clipboard.writeText(text).then(() => {
    copyBtn.textContent = "Copied!";
    copyBtn.classList.add("ok");
    setTimeout(() => { copyBtn.textContent = "Copy"; copyBtn.classList.remove("ok"); }, 1800);
  });
});

// ‚îÄ‚îÄ‚îÄ Clear ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
clearBtn.addEventListener("click", () => {
  selectedFiles = [];
  fileInput.value = "";
  previewsEl.innerHTML = "";
  outputEl.innerHTML = "";
  logEl.textContent = "";
  outputCard.style.display = "none";
  progressWrap.style.display = "none";
  progressBar.style.width = "0%";
  copyBtn.disabled = true;
  updateRunBtn();
});

// Initial state
updateRunBtn();
</script>
</body>
</html>
